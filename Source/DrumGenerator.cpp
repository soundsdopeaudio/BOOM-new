#include "DrumGenerator.h"
#include <map>
#include <deque>
#include <algorithm>
#include <chrono>



namespace boom {
    namespace drums {

        // ---------- internal storage ----------
        static std::map<std::string, std::vector<std::vector<std::string>>> gBanks;
        static std::mutex gBanksMutex;

        // forward-only global seed
        static std::atomic<uint32_t> gGlobalSeedCounter{ (uint32_t)(std::chrono::steady_clock::now().time_since_epoch().count() & 0xffffffffu) };
        uint32_t getNextGlobalSeed()
        {
            return static_cast<uint32_t>(gGlobalSeedCounter.fetch_add(1u, std::memory_order_relaxed) + 1u);
        }

        // ---------- helper RNG ----------
        static std::mt19937 makeRng(int seed)
        {
            if (seed < 0)
            {
                std::random_device rd;
                return std::mt19937(rd());
            }
            return std::mt19937((uint32_t)seed);
        }

        // small clamp helper used in multiple places
        template<typename T>
        static T clampT(T v, T lo, T hi) { return (v < lo) ? lo : (v > hi) ? hi : v; }

        // comparator type for juce::Array::sort (must be an lvalue)
        struct DrumNoteComparator
        {
            // JUCE expects a compareElements(...) returning an int (negative/zero/positive).
            int compareElements(const DrumNote& a, const DrumNote& b) const noexcept
            {
                if (a.startTick != b.startTick) return (a.startTick < b.startTick) ? -1 : 1;
                if (a.row != b.row)               return (a.row < b.row) ? -1 : 1;
                return 0;
            }

            // Keep operator() for use with std::sort/std::stable_sort if needed.
            bool operator()(const DrumNote& a, const DrumNote& b) const noexcept
            {
                if (a.startTick != b.startTick) return a.startTick < b.startTick;
                return a.row < b.row;
            }
        };
        static DrumNoteComparator drumNoteComparatorInstance;

        // ---------- template bank registration (you can extend / replace content) ----------
        void registerDefaultTemplateBanks()
        {
            std::lock_guard<std::mutex> lk(gBanksMutex);
            gBanks.clear();

            // --- TRAP (examples already in your project; here are a bunch to start) ---
            gBanks["trap"] = {
                    { "1000000010000000","0000100000001000","1010101010101010","0000000000010000","0000001000000000","0001000000000000","0000000000000000" },
                    { "1000010010001000","0000100000001000","1110111011101110","0000000010000000","0000001000001000","0001000000000000","0000000000000000" },
                    { "1000000010000000","0000000000001000","1010001010001010","0000000000000000","0000000001000000","0000000001000000","0000000000000000" },
                    { "1001001000010000","0000100000001000","1111111111111111","0000000000010000","0000011000000001","0000100000000000","0000000000000000" },
                    { "1000000001000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000001000000000","0000000000000000" },
                    { "1000000010000000","0000100000001000","1101101101101101","0000000000000000","0001000000001000","0000000001000000","0000000000000000" },
                        { "1000000010000000","0000100000001000","1010101010101010","0000000000010000","0000001000000000","0001000000000000","0000000000000000" },
    { "1000010010001000","0000100000001000","1110111011101110","0000000010000000","0000001000001000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000000000001000","1010001010001010","0000000000000000","0000000001000000","0000000001000000","0000000000000000" },
    { "1001001000010000","0000100000001000","1111111111111111","0000000000010000","0000011000000001","0000100000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000001000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1101101101101101","0000000000000000","0001000000001000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010111010101110","0000000000010000","0000000000001000","0001000000000010","0000000000000000" },
    { "1000100010000000","0000000000001000","1010101110101010","0000000000010000","0000001000000000","0000000000100000","0000000000000000" },
    { "1000000001000000","0000100000001000","1001101010101010","0000000010000000","0000000100000000","0000100000000000","0000000000000000" },
    { "1000001010000000","0000100010001000","1110111011101110","0000000000000000","0000010000001000","0001000000000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1010101010111010","0000000000010000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1101101101110110","0000000000010000","0000010000000000","0000001000000000","0000000000000000" },
        { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000001000000000","0000001000000000","0000000000000000" },
    { "1000000001000000","0000100010001000","1110111011101110","0000000000010000","0000000000000000","0000001000000000","0000000000000000" },
    { "1000000010000000","0000000000001000","1010100010101010","0000000000010000","0000000001000000","0000000000001000","0000000000000000" },
    { "1000000010001000","0000100000001000","1111110111101110","0000000000000000","0000010000000000","0000000000001000","0000000000000000" },
    { "1001000001001000","0000100000001000","1010111010101110","0000000000010000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100001001000","1111111111111111","0000000000000000","0001000000001000","0000000000000000","0000000000000000" },
    { "1000001001000000","0000100000001000","1010101110101010","0000000000010000","0000010000001000","0000001000000000","0000000000000000" },
    { "1000010001000010","0000100000001000","1101101101101101","0000000000000000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000001","0000100000001000","1110111011101110","0000000000010000","0000001000001000","0000000000000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010101010101010","0000000000010000","0000000000001000","0000001000000000","0000000000000000" },
    { "1000100010000000","0000100000001000","1001101010101010","0000000000000000","0000001000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100010001000","1010101010101010","0000000000010000","0001000000000000","0000000001000000","0000000000000000" },
    { "1000010010001000","0000100000001000","1110111011101110","0000000000000000","0000011000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000000000001000","1010100010101010","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1110111011101110","0000000000000000","0000001000001000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000000000","1010101010101010","0000000000010000","0000000001000000","0000000000100000","0000000000000000" },
    { "1000000001001000","0000100000001000","1010111010101110","0000000000010000","0001000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1101101101110110","0000000000000000","0000010000000000","0000001000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010111010","0000000000010000","0000000000001000","0000000001000000","0000000000000000" },
    { "1000010010000000","0000100000001000","1010101010101010","0000000000010000","0000001000000000","0000000000001000","0000000000000000" },
    { "1000000010001000","0000100000001000","1110111011101110","0000000000000000","0000010000001000","0000000000100000","0000000000000000" },
    { "1000000010000000","0000100010001000","1010100010101010","0000000000010000","0000010000000000","0000001000000000","0000000000000000" },
    { "1001000001000000","0000100000001000","1111111111111111","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010001010","0000000000000000","0000001000000000","0001000000000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1101101101101101","0000000000010000","0000000001000000","0000000000000000","0000000000000000" }
            };

            // --- HIP-HOP ---
            gBanks["hip-hop"] = {
                    { "1000000010000000","0000100000001000","1000100010001000","0000000000000000","0000001000000000","0001000000000000","0000000000000000" },
                    { "1000000010000000","0000000000001000","1010101001010101","0000000000010000","0000000000000000","0000010000000000","0000000000000000" },
                    { "1000000010001000","0000100000001000","1110111011101110","0000000000000000","0000001000001000","0000000000100000","0000000000000000" },
                    { "1000000010000000","0000100000001000","1010100010101010","0000000000010000","0000000100000000","0001000000000000","0000000000000000" },
                        { "1000000010000000","0000100000001000","1000100010001000","0000000000000000","0000001000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000000000001000","1010101001010101","0000000000010000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1110111011101110","0000000000000000","0000001000001000","0000000000100000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101010","0000000000010000","0000000100000000","0001000000000000","0000000000000000" },
    { "1000000000000000","0000100000001000","1000100010001000","0000000000000000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000000010000000","1010010010101010","0000000000010000","0000000000001000","0000000001000000","0000000000000000" },
    { "1000000001000000","0000100000101000","1010101010101010","0000000000000000","0000001100000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000010000","1010100010001000","0000000000010000","0000000100001000","0000000000100000","0000000000000000" },
    { "1000000010000000","0000000010001000","1000100010101000","0000000000000000","0000001000000000","0000010000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1111110111101110","0000000000010000","0000000000001000","0000000000100000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1001000000000000","0000100000001000","1001101010101010","0000000000010000","0000001000000000","0000000000000000","0000000000000000" },
        { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000001000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000000000","1010101001010101","0000000000010000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000001000000","0000000000001000","1010010010101010","0000000000000000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000100000010000","1000100010001000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000000010001000","1010100010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1000100010101000","0000000000000000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1110111011101110","0000000000010000","0000000001000000","0000000000001000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010101010101010","0000000000000000","0000000100000000","0000001000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1001101010101010","0000000000010000","0000000000001000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101010","0000000000000000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010111010101110","0000000000000000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010101010","0000000000010000","0000000000000000","0000010000000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1000100010001000","0000000000010000","0000000000001000","0000000000100000","0000000000000000" },
    { "1000000010000000","0000100010001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1110111011101110","0000000000000000","0000010000001000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010100010101010","0000000000010000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010101010111010","0000000000000000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101110","0000000000010000","0000000000000000","0000000001000000","0000000000000000" }

            };
            gBanks["hiphop"] = gBanks["hip-hop"];

            // --- DRILL ---
            gBanks["drill"] = {
                    { "1000010001000010","0000100000001000","1101101101101101","0000000000000000","0001000001000000","0000001000000000","0000000000000000" },
                    { "1001001000100000","0000100000001000","1111110111101111","0000000000010000","0000010000001000","0000000001000000","0000000000000000" },
                    { "1001000001001000","0000100000001000","1101101101101101","0000000000010000","0000001000001000","0001000000000000","0000000000000000" },
                        { "1000010001000010","0000100000001000","1101101101101101","0000000000000000","0001000001000000","0000001000000000","0000000000000000" },
    { "1001001000100000","0000100000001000","1111110111101111","0000000000010000","0000010000001000","0000000001000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1101101101101101","0000000000010000","0000001000001000","0001000000000000","0000000000000000" },
    { "1000100010001000","0000100000001000","1110111111101110","0000000000000000","0000000000001000","0000100000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1101101101110110","0000000000010000","0000010000000000","0001000000000000","0000000000000000" },
    { "1001001001001000","0000100000001000","1111111111111111","0000000000000000","0001000000001000","0000001000000000","0000000000000000" },
    { "1001000001000000","0000100000001000","1101101101101101","0000000000010000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000001001000000","0000100000001000","1110111011110111","0000000000000000","0000000001001000","0000000000000000","0000000000000000" },
    { "1001000010001000","0000100000001000","1101101111101101","0000000000010000","0001000000001000","0000000000000000","0000000000000000" },
    { "1000010001000010","0000100000001000","1110111011101110","0000000000000000","0000010001000000","0000000000000000","0000000000000000" },
    { "1001001000001000","0000100000001000","1101110111011101","0000000000010000","0000001000001000","0001000000000000","0000000000000000" },
    { "1000000010000010","0000100000001000","1111110111101111","0000000000010000","0000000000001000","0000000001000000","0000000000000000" },
        { "1000010001000010","0000100000001000","1101101101101101","0000000000000000","0001000001000000","0000001000000000","0000000000000000" },
    { "1001001000100000","0000100010001000","1111110111101111","0000000000010000","0000010000001000","0000000001000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1101101101110110","0000000000000000","0000001000001000","0001000000000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1110111011101110","0000000000010000","0000010000000000","0000001000000000","0000000000000000" },
    { "1000001001000000","0000100000001000","1101101101101101","0000000000000000","0001000000001000","0000000000001000","0000000000000000" },
    { "1000100010001000","0000100000001000","1110111011101110","0000000000000000","0000000000001000","0000000001000000","0000000000000000" },
    { "1000010001001000","0000100000001000","1101101111101101","0000000000010000","0000010001000000","0000000000000000","0000000000000000" },
    { "1001000010001000","0000100000001000","1111111111111111","0000000000000000","0001000000000000","0000000001000000","0000000000000000" },
    { "1000000010000010","0000100000001000","1101110111011101","0000000000010000","0000010000001000","0000000000000000","0000000000000000" },
    { "1001001000001000","0000100000001000","1110111011101110","0000000000000000","0000001000001000","0000000000001000","0000000000000000" },
    { "1000001010000000","0000100000001000","1101101101101101","0000000000010000","0001000000001000","0000000001000000","0000000000000000" },
    { "1001001001001000","0000100000001000","1110111011101110","0000000000000000","0000010000000000","0000000000000000","0000000000000000" },
    { "1000100010000000","0000100000001000","1101101101101101","0000000000010000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1111110111101111","0000000000010000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1101101101110110","0000000000000000","0000010001000000","0000000001000000","0000000000000000" },
    { "1001000001000000","0000100000001000","1110111011101110","0000000000010000","0001000000000000","0000000000001000","0000000000000000" },
    { "1000001000001000","0000100000001000","1101101101101101","0000000000000000","0000010000001000","0000000001000000","0000000000000000" },
    { "1000000010000010","0000100000001000","1110111011101110","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1101101101101101","0000000000010000","0000001000001000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1111110111101111","0000000000010000","0000010000001000","0000000001000000","0000000000000000" },
    { "1000100001001000","0000100000001000","1101101101101101","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1110111011101110","0000000000010000","0000001000000000","0000000001000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1101110111011101","0000000000000000","0000010000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1111110111101111","0000000000010000","0000000001000000","0000000000001000","0000000000000000" }
            };

            // --- REGGAETON (dembow-like templates) ---
            gBanks["reggaeton"] = {
                    { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000001000000000","0000000000000000" },
                    { "1000000010000000","0000000010001000","1010101001010101","0000000000010000","0000001000001000","0000000001000000","0000000000000000" },
                    { "1000000010001000","0000010000001000","1010111010101110","0000000000000000","0000010000000010","0001000000000000","0000000000000000" },
                        { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000001000000000","0000000000000000" },
    { "1000000010000000","0000000010001000","1010101001010101","0000000000010000","0000001000001000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000010000001000","1010111010101110","0000000000000000","0000010000000010","0001000000000000","0000000000000000" },
    { "1000000000010000","0000010000010000","1010101010101010","0000000000000000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101000101010","0000000000000000","0000010000000010","0000000000100000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101011101010","0000000000010000","0000010000000010","0000001000000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000000","0000001000000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101001010101","0000000000000000","0000000001000010","0000000000001000","0000000000000000" },
    { "1000000010001000","0000010000001000","1010111010101110","0000000000010000","0000010000000010","0000001000001000","0000000000000000" },
    { "1000000000010000","0000010000001000","1000101001010101","0000000000000000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010000000","0000010000010000","1010101010101010","0000000000000000","0000010000000010","0000000000000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000010000","0000010000000010","0000001000000000","0000000000000000" },
        { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000001000000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101001010101","0000000000010000","0000001000001000","0000000001000000","0000000000000000" },
    { "1000000000010000","0000010000010000","1010101010101010","0000000000000000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000010001000","0000010000001000","1010111010101110","0000000000010000","0000010000000010","0000001000001000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000010000","0000010000000010","0000000000000000","0000000000000000" },
    { "1000000010000000","0000010000010000","1010101010101010","0000000000010000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000010000000","0000010000001000","1000101001010101","0000000000000000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000010000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000010001000","0000010000001000","1000101001010101","0000000000000000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101001010101","0000000000010000","0000010000000000","0000000001000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010100010","0000000000000000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000000000000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000010000","0000010000000010","0000001000000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101001010101","0000000000010000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010001000","0000010000001000","1010111010101110","0000000000000000","0000010000000010","0000000000000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000010000","0000010000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000010000000","0000010000001000","1000101010101010","0000000000010000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000000000000000","0000000000000000" },
    { "1000000000010000","0000010000010000","1010101010101010","0000000000010000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000010001000","0000010000001000","1010111010101110","0000000000010000","0000010000000010","0000000001000000","0000000000000000" },
    { "1000000000010000","0000010000001000","1010101010101010","0000000000000000","0000010000000010","0000000000001000","0000000000000000" },
    { "1000000010000000","0000010000001000","1010101001010101","0000000000010000","0000010000000010","0000000000000000","0000000000000000" }

            };

            // --- RnB ---
            gBanks["rnb"] = {
                    { "1000000010000000","0000100000001000","1010010010101010","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
                    { "1000000010000000","0000100000001000","1010001010001000","0000000100000000","0000001000000000","0000000001000000","0000000000000000" },
                        { "1000000010000000","0000100000001000","1010010010101010","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010001000","0000000100000000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000000000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010100010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010010010101010","0000000000010000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010001010001000","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1000000001000000","0000100001001000","1010101010101010","0000000000000000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1001100010101010","0000000000010000","0000000000000000","0000001000000000","0000000000000000" },
    { "1000000000000000","0000100000001000","1010001010101010","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010100010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1010010010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000000000","0000000000000000","0000001000000000","0000000000000000" },
        { "1000000010000000","0000100000001000","1010010010101010","0000000000010000","0000000000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010001000","0000000100000000","0000001000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000000000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010100010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010010010101010","0000000000010000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010101010","0000000000000000","0000000000000000","0001000000000000","0000000000000000" },
    { "1000000010000000","0000100000000000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100010001000","1001100010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010100010100010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1000100010001000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010010010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101010","0000000000000000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000100010001000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010101000","0000000000010000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010010010101010","0000000000000000","0000000000000000","0000000000100000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010001010001000","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1000100010001000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100010001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010100010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000101010101010","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" }
            };
            gBanks["r&b"] = gBanks["rnb"];

            // --- POP ---
            gBanks["pop"] = {
                    { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
                    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000100000000","0000000000000000","0000000000000000" },
                        { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000100000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000001000","0000010000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000101010001000","0000000000000000","0000000000000000","0000000000100000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000001000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010101000","0000000000000000","0000000100001000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010100010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101000","0000000000010000","0000000001000000","0000000000000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000000000","0000010000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000100000000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010101010101110","0000000000010000","0000001000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010111010101010","0000000000000000","0000000000001000","0000000001000000","0000000000000000" },
        { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000100000000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100001001000","1010100010101010","0000000000010000","0000000000000000","0000000000100000","0000000000000000" },
    { "1001000010000000","0000100000001000","1000100010001000","0000000000010000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010111010101110","0000000000000000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101000","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010101000","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1010101010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1001101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1001000010000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000001000001000","0000100000001000","1010111010101110","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010100010101010","0000000000010000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1010101010101010","0000000000010000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000000000000","0000000000000000" },
    { "1001000001001000","0000100000001000","1010101010101010","0000000000010000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000001000000","0000000000000000","0000000000000000" },
    { "1000000010001000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100010001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000001000000","0000100000001000","1000100010001000","0000000000010000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010010000","0000100000001000","1010100010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000010000","0000000000000000","0000000001000000","0000000000000000" },
    { "1000000010000000","0000100000001000","1000101010101010","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000010000000","0000100000001000","1010101010101010","0000000000000000","0000000000001000","0000000000000000","0000000000000000" }
            };

            // --- WXSTIE (sparse, more rests) ---
            gBanks["wxstie"] = {
                    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
                    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
                        { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000010000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000100000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000001000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000000000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000001000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
        { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000010000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000100000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000001000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000000000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000001000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010001000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000000000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000001000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000001000","0000000000000000","1000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1010000000001000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000001000000","0000000000000000","1000000010000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010000000","0000000000000000","0000000000000000","0000000000001000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000010001000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" },
    { "1000000000000000","0000000000000000","1000000000000000","0000000000000000","0000000000001000","0000000000000000","0000000000000000" }
            };
            gBanks["wxst"] = gBanks["wxstie"];

            // --- FREEFORM (fallback) ---
            gBanks["freeform"] = {
                { "1001001001001001","0000100000001000","1111111111111111","0000000000010000","0001010000010100","0000100000010000","0000000000000000" }
            };

            // You can append the large lists you previously pasted into these vectors.
        }

        // retrieve reference (returns freeform fallback if not found)
        const std::vector<std::vector<std::string>>& getPatternBank(const std::string& style)
        {
            static const std::vector<std::vector<std::string>> emptyFallback = { { "0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000" } };
            std::lock_guard<std::mutex> lk(gBanksMutex);
            auto it = gBanks.find(style);
            if (it != gBanks.end()) return it->second;

            // try lowercase match
            for (auto& kv : gBanks)
            {
                std::string key = kv.first;
                std::string s = style;
                std::transform(key.begin(), key.end(), key.begin(), ::tolower);
                std::transform(s.begin(), s.end(), s.begin(), ::tolower);
                if (key == s) return kv.second;
            }

            return gBanks.count("freeform") ? gBanks["freeform"] : emptyFallback;
        }

        // ---------- utilities ----------
        static int safeCharToBit(char c) { return (c == '1') ? 1 : 0; }

        // ensure note is valid and append to pattern (uses DrumNote / DrumPattern from DrumStyles.h)
        static void appendNote(DrumPattern& out, int row, int stepIndex, int bars, int vel)
        {
            DrumNote n;
            n.row = row;
            n.startTick = stepIndex * kTicksPer16th;
            n.lenTicks = kTicksPer16th;
            n.vel = juce::jlimit(1, 127, vel);
            out.add(n);
        }

        // appendHitToPattern: convert internal Hit to DrumNote and add to DrumPattern
        static void appendHitToPattern(boom::drums::DrumPattern& out, const Hit& h)
        {
            DrumNote n;
            n.row = h.row;
            n.startTick = h.stepIndex * kTicksPer16th;
            n.lenTicks = juce::jmax(1, h.lenSteps) * kTicksPer16th;
            n.vel = clampT(h.vel, 1, 127);
            out.add(n);
        }

        // sort by startTick then by row (juce::Array has sort())
        static void sortPattern(DrumPattern& p)
        {
            p.sort(drumNoteComparatorInstance);
        }

        // Apply simple humanization & swing
        static void applyHumanizeAndSwing(DrumPattern& pattern, int humanizeTiming, int humanizeVelocity, int swingPct, std::mt19937& rng)
        {
            if (pattern.size() == 0) return;
            std::uniform_int_distribution<int> jitterDist(-juce::jmax(1, humanizeTiming / 2), juce::jmax(1, humanizeTiming / 2));
            std::uniform_int_distribution<int> velJitDist(-juce::jmax(1, humanizeVelocity / 2), juce::jmax(1, humanizeVelocity / 2));
            int swingTicks = (swingPct * kTicksPer16th) / 200; // small amount

            for (int i = 0; i < pattern.size(); ++i)
            {
                auto& n = pattern.getReference(i);

                // swing: if the 16th is odd, push forward by swingTicks
                int stepIdx = n.startTick / kTicksPer16th;
                if ((stepIdx % 2) != 0 && swingPct > 0)
                    n.startTick += swingTicks;

                // jitter
                n.startTick = juce::jmax(0, n.startTick + jitterDist(rng));
                n.vel = juce::jlimit(1, 127, n.vel + velJitDist(rng));
            }
        }

        // Convert fraction-of-time rule to step index in 16-step grid for 4/4
        static int beatToStep(int beatIndex /*1-based*/, int subStep /*0..*/, int stepsPerBar)
        {
            // beats are 1..4; place on beat start: (beatIndex-1) * (stepsPerBar/4) + subStep
            int perBeat = stepsPerBar / 4;
            return (beatIndex - 1) * perBeat + subStep;
        }

        // If pattern lacks a snare on desired step, force one with given probability
        static void enforceSnareRule(DrumPattern& out, int bars, int stepsPerBar, int targetStepGlobal, int rowSnare, float chancePct, int vel)
        {
            if (chancePct <= 0.0f) return;

            // check if there's already a snare at that step
            bool found = false;
            const int targetTick = targetStepGlobal * kTicksPer16th;
            for (int i = 0; i < out.size(); ++i)
            {
                auto& n = out.getReference(i);
                if (n.row == rowSnare && n.startTick == targetTick) { found = true; break; }
            }
            if (!found)
            {
                // roll RNG
                std::random_device rd;
                std::mt19937 rng(rd());
                std::uniform_real_distribution<float> u(0.0f, 100.0f);
                if (u(rng) <= chancePct)
                {
                    DrumNote n;
                    n.row = rowSnare;
                    n.startTick = targetTick;
                    n.lenTicks = kTicksPer16th;
                    n.vel = vel;
                    out.add(n);
                }
            }
        }

        // convert some hits to triplet-grid hits
        // effectiveTripletDensityPct controls what PERCENTAGE of notes get converted (0-100)
        static void applyTripletConversion(DrumPattern& out, int bars, int stepsPerBar, float effectiveTripletDensityPct, std::mt19937& rng)
        {
            if (effectiveTripletDensityPct <= 0.0f) return;
            std::uniform_real_distribution<float> u(0.0f, 100.0f);

            // For each hit, roll the dice: if random value < density%, convert this note to triplet timing
            for (int i = 0; i < out.size(); ++i)
            {
                auto& n = out.getReference(i);
                
                // CRITICAL FIX: This roll determines if THIS note gets triplet timing
                // Lower density = fewer notes converted; higher density = more notes converted
                if (u(rng) > effectiveTripletDensityPct) 
                    continue; // skip this note, keep it on the regular 16th grid
                
                // Convert this note to nearest triplet grid position
                int stepIndex = n.startTick / kTicksPer16th;
                int barIdx = stepIndex / stepsPerBar;
                int inBar = stepIndex % stepsPerBar;
                int tripletSlotsPerBar = 12;
                float frac = (inBar / (float)stepsPerBar) * tripletSlotsPerBar;
                int tslot = juce::jlimit(0, tripletSlotsPerBar - 1, (int)std::round(frac));
                int newGlobalStep = barIdx * tripletSlotsPerBar + tslot;
                n.startTick = newGlobalStep * kTicksPerTriplet16th;
            }
        }

        // convert some hits to dotted lengths (increase length by 1.5x)
        // dottedDensityPct controls what PERCENTAGE of notes get dotted lengths (0-100)
        static void applyDottedLengths(DrumPattern& out, float dottedDensityPct, std::mt19937& rng)
        {
            if (dottedDensityPct <= 0.0f) return;
            std::uniform_real_distribution<float> u(0.0f, 100.0f);
            
            // For each note, roll the dice: if random value < density%, make this note dotted
            for (int i = 0; i < out.size(); ++i)
            {
                auto& n = out.getReference(i);
                
                // CRITICAL FIX: This roll determines if THIS note gets dotted length
                // Lower density = fewer notes get dotted; higher density = more notes get dotted
                if (u(rng) <= dottedDensityPct)
                {
                    n.lenTicks = juce::jmax(1, (int)std::round(n.lenTicks * 1.5f));
                }
            }
        }

        // -------------------------- main generate --------------------------
        DrumPattern generate(const GenerationSpec& spec)
        {
            DrumPattern out;
            out.clearQuick();

            // sanity clamp bars
            int bars = juce::jlimit(1, 8, spec.bars);
            int stepsPerBar = kDefaultStepsPerBar; // 16

            // RNG
            std::mt19937 rng = makeRng(spec.seed < 0 ? (int)getNextGlobalSeed() : spec.seed);

            // Choose the bank
            const auto& bank = getPatternBank(spec.style);

            // If bank empty, return empty pattern (shouldn't happen)
            if (bank.empty()) return out;

            // select one or more templates (simple approach: pick 1 main template)
            std::uniform_int_distribution<size_t> pick(0, bank.size() - 1);
            size_t idx = pick(rng);
            const auto& tmpl = bank[idx];

            // tmpl is vector<string> of length rows (7) each 16 chars.
            // Expand to bars: repeat each bar segment for number of bars.
            int rows = (int)tmpl.size(); // expected 7
            for (int r = 0; r < rows; ++r)
            {
                const std::string& rowStr = tmpl[r];
                for (int bar = 0; bar < bars; ++bar)
                {
                    for (int s = 0; s < stepsPerBar; ++s)
                    {
                        char c = (s < (int)rowStr.size()) ? rowStr[s] : '0';
                        if (c == '1')
                        {
                            int globalStep = bar * stepsPerBar + s;
                            appendNote(out, r, globalStep, bars, 100);
                        }
                    }
                }
            }

            // --- Style snare rules ---
            const int snareRow = 1;
            std::string styleLower = spec.style;
            std::transform(styleLower.begin(), styleLower.end(), styleLower.begin(), ::tolower);

            auto enforceSnareOn3 = [&](float probPct)
            {
                for (int bar = 0; bar < bars; ++bar)
                {
                    int targetStep = beatToStep(3, 0, stepsPerBar) + bar * stepsPerBar;
                    enforceSnareRule(out, bars, stepsPerBar, targetStep, snareRow, probPct, 110);
                }
            };

            if (styleLower.find("drill") != std::string::npos)
            {
                enforceSnareRule(out, bars, stepsPerBar, beatToStep(3, 0, stepsPerBar), snareRow, 85.0f, 115);
                if (bars >= 2) enforceSnareRule(out, bars, stepsPerBar, beatToStep(4, 0, stepsPerBar) + stepsPerBar, snareRow, 60.0f, 110);
                std::uniform_real_distribution<float> u(0.0f, 100.0f);
                for (int b = 0; b < bars; ++b)
                {
                    if (u(rng) < 50.0f)
                    {
                        int step = b * stepsPerBar + (stepsPerBar / 4 + stepsPerBar / 8); // approx & of 2
                        enforceSnareRule(out, bars, stepsPerBar, step, snareRow, 100.0f, 95);
                    }
                }
            }
            else if (styleLower.find("reggaeton") != std::string::npos)
            {
                enforceSnareRule(out, bars, stepsPerBar, beatToStep(6, 0, stepsPerBar), snareRow, 90.0f, 110);
            }
            else if (styleLower.find("rnb") != std::string::npos || styleLower.find("pop") != std::string::npos)
            {
                enforceSnareOn3(92.0f);
            }
            else if (styleLower.find("rock") != std::string::npos)
            {
                enforceSnareOn3(75.0f);
            }
            else if (styleLower.find("trap") != std::string::npos)
            {
                enforceSnareOn3(65.0f);
            }
            else if (styleLower.find("wxst") != std::string::npos)
            {
                enforceSnareOn3(50.0f);
            }
            else
            {
                enforceSnareOn3(40.0f);
            }

            // --- Triplet/dotted handling ---
            float styleTripMultiplier = 1.0f;
            if (styleLower.find("drill") != std::string::npos) styleTripMultiplier = 1.6f;
            if (styleLower.find("trap") != std::string::npos) styleTripMultiplier = 1.15f;
            if (styleLower.find("hip") != std::string::npos || styleLower.find("rnb") != std::string::npos || styleLower.find("pop") != std::string::npos)
                styleTripMultiplier *= 0.6f;

            // --- Triplet/dotted handling ---
            // Normalize UI densities to 0..100, clamp after style multipliers.
            // This prevents "everything becomes triplet/dotted" regardless of slider position.

            auto normalizePct01or100 = [](float v) -> float
                {
                    // If the parameter is coming in as 0..1, convert to 0..100.
                    // If it is already 0..100, leave it.
                    if (v <= 1.0f)
                        return v * 100.0f;

                    return v;
                };

            float tripletUiPct = spec.useTriplets ? normalizePct01or100((float)spec.tripletDensity) : 0.0f;
            float dottedUiPct = spec.useDotted ? normalizePct01or100((float)spec.dottedDensity) : 0.0f;

            // Apply style multiplier, then clamp to 0..100 so we never hit "convert every note"
            float effectiveTripletPct = juce::jlimit(0.0f, 100.0f, tripletUiPct * styleTripMultiplier);
            float effectiveDottedPct = juce::jlimit(0.0f, 100.0f, dottedUiPct);

            applyTripletConversion(out, bars, stepsPerBar, effectiveTripletPct, rng);
            applyDottedLengths(out, effectiveDottedPct, rng);

            // Humanize & swing
            applyHumanizeAndSwing(out, spec.humanizeTiming, spec.humanizeVelocity, spec.swingPct, rng);

            // final sort & clamp
            sortPattern(out);

            return out;
        }

    } // namespace drums
} // namespace boom
